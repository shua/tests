<html>
<head>
<script>
var levels = {
    rows: Array(12),
    offset: 0,
    chance: .3,
    createRow: function() {
        row = Array(10);
        for(var i = 0; i < 10; ++i) {
            row[i] = (Math.random() < this.chance);
        }
        return row;
    },
    move: function(delta) {
        if(delta != 0 && this.chance > .01) {
            this.chance -= delta/100000;
            if(this.chance < .01) this.chance = .01;
        }
        delta += this.offset;
        var push = Math.floor(delta/30);
        if(push != 0) {
            delta -= (push * 30);
            for(var i = this.rows.length - 1; i >= push; --i) {
                this.rows[i] = this.rows[i-push];
            }
            for(var i = 0; i < push; ++i) {
                this.rows[i] = this.createRow();
            }
        }
        this.offset = delta;
    },
    draw: function(context) {
        for(var i = 1; i < 12; ++i) {
            var yoff = (i-2) * 30 + this.offset;
            for( var j = 0; j < 10; ++j) {
                if(this.rows[i][j])
                    context.fillRect(j*30, yoff, 30, 4);
                context.strokeRect(j*30, yoff, 30,30);
            }
        }
    }
};

keyEnum = { LEFT:0, RIGHT:1, SPACE:2}
var keyArray = [false, false, false];

var ball = {
    x: 150,
    y: 300,
    vx: 0,
    vy: 0,
    r: 5,
    draw: function(context) {
        context.beginPath();
        context.arc(this.x, this.y-this.r, this.r, 0, 2*Math.PI);
        context.fill();
        context.stroke();
    },
    update: function() {
        this.vx = ((keyArray[keyEnum.LEFT] * -1) + (keyArray[keyEnum.RIGHT] * 1));
        this.vy += .01;
        this.x += this.vx;
        this.y += this.vy;
        if(this.x > 305)
            this.x -= 310;
        if(this.x < -5)
            this.x += 310;
    }
};

var jumptracker = {
    amt: 20,
    draw: function(context) {
        if(this.amt > 10) {
            context.fillRect(10,10,20,5);
            context.fillRect(35,10,(this.amt-10)*2, 5);
        } else {
            context.fillRect(10,10,this.amt*2, 5);
        }
    },
    jump: function() {
        if(this.amt >= 10) {
            this.amt -= 10;
            ball.vy = -3;
        }
    },
    feed: function() {
        if(this.amt <= 20) ++(this.amt);
    }
};

function checkCollide(row) {
    if(row == undefined)
        return false;
    var index = Math.floor((ball.x)/30);
    var collision = false;
    if(row[index] != undefined) {
        collision = row[index];
        row[index] = false;
    }
    return collision;
};

function onKeyDown(event) {
    if( event.keyCode == 37 )
        keyArray[keyEnum.LEFT] = true;
    if( event.keyCode == 39 )
        keyArray[keyEnum.RIGHT] = true;
    if( event.keyCode == 32 )
        keyArray[keyEnum.SPACE] = true;
};

function onKeyUp(event) {
    if( event.keyCode == 37 )
        keyArray[keyEnum.LEFT] = false;
    if( event.keyCode == 39 )
        keyArray[keyEnum.RIGHT] = false;
    if( event.keyCode == 32 )
        keyArray[keyEnum.SPACE] = false;
};

window.onload = function() {
    var c = document.getElementById('jumper');
    var ctx = c.getContext('2d');
    ctx.font='bold 25px Helvetica';
    window.addEventListener('keydown', onKeyDown);
    window.addEventListener('keyup', onKeyUp);
    for(var i = 0; i < 12; ++i)
        levels.rows[i] = levels.createRow();

    var ls = false;
    if(typeof(Storage) != "undefined")
        ls = true;
    var maxheight = 0;
    if(ls && localStorage.maxheight != undefined)
        maxheight = localStorage.maxheight;
    var height = 0;
    var lose = false;
    var newmax = false;

    function drawField(rowind) {
        ctx.clearRect(0,0,300,300);
        ctx.fillStyle='#422';
        ctx.fillRect(0, (rowind - 2)*30 + levels.offset, 300, 30);
        ctx.fillStyle='#2f2';
        levels.draw(ctx);
        ctx.fillStyle='#f22';
        ball.draw(ctx);
    }

    setInterval(function() {
        if(lose) {
        newmax |= (height > maxheight*30);
        drawField();
        ctx.fillStyle='rgba(32,32,32,0.5)'
        ctx.fillRect(0,0,300,300);
        ctx.fillStyle='#aaa';
        ctx.font='bold 40px Helvetica';
        if(newmax) {
            maxheight = Math.floor(height/3)/10;
            ctx.fillText('Alright', 30, 120 + levels.offset);
            ctx.font='bold 20px Helvetica';
            ctx.fillText('New max height: ' + maxheight, 40, 150 + levels.offset);
            if(ls)
                localStorage.maxheight = maxheight;
        } else {
            ctx.fillText('Oh, well', 30, 120 + levels.offset);
            ctx.font='bold 20px Helvetica';
            ctx.fillText('Score to beat: ' + maxheight, 40, 150 + levels.offset);
        }
        } else {
        ball.update();
        var offset = 0;
        if(ball.y < 100)
            offset = Math.floor(100 - ball.y);
        if(height < 200 && (300 - ball.y) > height)
            height = Math.floor(300 - ball.y);
        if(ball.y > 300)
            if(height > 200)
                lose = true;
            else
                ball.vy = -1;
        levels.move(offset);
        ball.y += offset;
        height += offset;
        var rowind = Math.floor((ball.y - levels.offset)/30) + 2;
        if((ball.vy > 0) && (((ball.y - levels.offset) % 30) < 10) && checkCollide(levels.rows[rowind])) {
            jumptracker.feed();
            ball.vy = -1;
            if(keyArray[keyEnum.SPACE])
                jumptracker.jump();
        }
        drawField(rowind);
        ctx.fillStyle='#aaa';
        var rheight = Math.floor(height/3)/10;
        ctx.fillText(rheight, 10, 280);
        ctx.strokeText(rheight, 10, 280);
        ctx.fillStyle='#2a2';
        jumptracker.draw(ctx);
        }
    });
}
</script>
</head>
<body style="background:#222;font-family:helvetica;color:#777">
<div style="position:relative;width:900px;height:auto;margin:auto">
<div style="height:260px;width:260px;text-align:right;padding:20px"><h1>Jumper</h1></div>
<canvas id="jumper" width="300" height="300" style="position:absolute;background:#333;border-radius:20px;left:300px;top:0px" ></canvas>
<div style="position:absolute;height:260px;width:260px;right:0px;top:0px;padding:20px"><h3>Controls:</h3><p>left, right, space</p></div>
</div>
</body>
</html>
